<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="style.css">
    <title>Search</title>
</head>
<body>
    <div class="w-1/2">
        <div class="search-box">
            <input autofocus="autofocus" type="search" class="search" placeholder="Search Documents in Amharic">
            <button class="btn">Search</button>
        </div>

        <div class="msg empty"></div>

        <div class="docs mt-3">
        </div>

    </div>

    <dialog>
    </dialog>

    <script>
        const btn = document.querySelector('button');
        const input = document.querySelector('input[type=search]');
        const msg = document.querySelector('.msg');
        const docs = document.querySelector('.docs');
        const dialog = document.querySelector('dialog');

        function showDoc(name, q) {
            const words = q.replace(/[^ሀ-ፖ\/\-]/mgi, ' ')
                .replace(/\s+/g, ' ')
                .trim()
                .split(' ')
                .filter(word => word.length > 1);

            dialog.showModal();
            dialog.innerText = 'Loading...';

            fetch(`/doc/${name}`).then(async res => {
                dialog.innerText = await res.text();

                btn.disabled = false;
                input.disabled = false;
            }).catch(e => {
                alert(e.message);
                dialog.close();
                btn.disabled = false;
                input.disabled = false;
            });
        }

        btn.onclick = () => {
            const q = input.value;

            if (q === '')
                return;

            btn.disabled = true;
            input.disabled = true;
            docs.innerHTML = '';
            msg.innerText = 'Searching...';

            fetch(`/search?q=${encodeURIComponent(q)}`).then(async res => {
                const {data, message} = await res.json();

                docs.innerHTML = data
                    .map(doc => (`<div onclick="showDoc('${doc.doc}', '${q}')" class="doc">${doc.doc}<span class="caption">${doc.stats}<span class="caption-end">${doc.score} ⭐</span></span></div>`))
                    .join('');

                btn.disabled = false;
                input.disabled = false;
                msg.innerText = message;
            }).catch(e => {
                msg.innerText = e.message;
                btn.disabled = false;
                input.disabled = false;
            });
        };

        const url = new URL(location.href);
        const q = url.searchParams.get('q');
        if (q != null) {
            input.value = q;
            btn.click();
        }
    </script>
</body>
</html>